<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Column Sum Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .csv-section {
            background: #f8fafc;
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .csv-section:hover {
            border-color: #4f46e5;
            background: #f1f5f9;
        }

        .csv-section.dragover {
            border-color: #4f46e5;
            background: #eef2ff;
            transform: scale(1.02);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e0f2fe;
            border-radius: 8px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .column-selector {
            margin-top: 30px;
            display: none;
        }

        .column-selector.show {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #374151;
        }

        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group select:focus {
            outline: none;
            border-color: #4f46e5;
        }

        .calculate-button {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .calculate-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(16, 185, 129, 0.3);
        }

        .calculate-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .results {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f59e0b;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            font-weight: 600;
            color: #92400e;
        }

        .result-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #78350f;
        }

        .csv-preview {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
        }

        .csv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .csv-table th,
        .csv-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .csv-table th {
            background: #f9fafb;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .csv-table tr:hover {
            background: #f9fafb;
        }

        .grouped-results {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
        }

        .reason-group {
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
        }

        .reason-group:last-child {
            margin-bottom: 0;
        }

        .reason-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #065f46;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reason-amount {
            font-size: 1.1em;
            color: #059669;
            font-weight: bold;
        }

        .reason-details {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.9em;
            color: #6b7280;
        }

        .extension-note {
            margin-top: 30px;
            padding: 20px;
            background: #ede9fe;
            border-left: 4px solid #8b5cf6;
            border-radius: 8px;
        }

        .extension-note h3 {
            color: #6d28d9;
            margin-bottom: 10px;
        }

        .extension-note p {
            color: #7c3aed;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bad Debt Analysis Tool</h1>
            <p>Upload your CSV file to analyze bad debt losses grouped by reason</p>
        </div>
        
        <div class="main-content">
            <div class="csv-section" id="csvSection">
                <h3>Upload CSV File</h3>
                <p>Drag and drop your CSV file here or click to browse</p>
                
                <div class="file-input-wrapper">
                    <input type="file" id="csvFile" class="file-input" accept=".csv" />
                    <button class="file-input-button">Choose CSV File</button>
                </div>
                
                <div class="file-info" id="fileInfo">
                    <strong>File loaded:</strong> <span id="fileName"></span><br>
                    <strong>Rows:</strong> <span id="rowCount"></span> | 
                    <strong>Columns:</strong> <span id="columnCount"></span>
                </div>
            </div>

            <div class="column-selector" id="columnSelector">
                <div class="form-group">
                    <label for="balanceColumnSelect">Select Balance Column:</label>
                    <select id="balanceColumnSelect">
                        <option value="">Choose balance column...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="reasonColumnSelect">Select Bad Debt Loss Reason Column:</label>
                    <select id="reasonColumnSelect">
                        <option value="">Choose reason column...</option>
                    </select>
                </div>
                
                <button class="calculate-button" id="calculateButton" disabled>Analyze Bad Debt</button>
            </div>

            <div class="results" id="results">
                <h3>Bad Debt Analysis Results</h3>
                <div class="result-item">
                    <span class="result-label">Total Bad Debt:</span>
                    <span class="result-value" id="totalBadDebt">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Number of Accounts:</span>
                    <span class="result-value" id="totalAccounts">-</span>
                </div>
                <div class="result-item">
                    <span class="result-label">Unique Reasons:</span>
                    <span class="result-value" id="uniqueReasons">-</span>
                </div>
            </div>

            <div class="grouped-results" id="groupedResults" style="display: none;">
                <h3>Bad Debt by Reason</h3>
                <div id="groupedResultsContent"></div>
            </div>

            <div class="csv-preview" id="csvPreview" style="display: none;">
                <table class="csv-table" id="csvTable">
                    <thead id="csvTableHead"></thead>
                    <tbody id="csvTableBody"></tbody>
                </table>
            </div>

            <div class="extension-note">
                <h3>ðŸ“Š Bad Debt Analysis Features</h3>
                <p>This tool analyzes bad debt by grouping accounts by loss reason and summing balance amounts. Perfect for understanding patterns in debt losses and identifying the most significant categories affecting your portfolio.</p>
            </div>
        </div>
    </div>

    <script>
        let csvData = [];
        let csvHeaders = [];

        // File input handling
        const csvFile = document.getElementById('csvFile');
        const csvSection = document.getElementById('csvSection');
        const fileInfo = document.getElementById('fileInfo');
        const columnSelector = document.getElementById('columnSelector');
        const balanceColumnSelect = document.getElementById('balanceColumnSelect');
        const reasonColumnSelect = document.getElementById('reasonColumnSelect');
        const calculateButton = document.getElementById('calculateButton');
        const results = document.getElementById('results');
        const groupedResults = document.getElementById('groupedResults');
        const csvPreview = document.getElementById('csvPreview');

        // Drag and drop functionality
        csvSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            csvSection.classList.add('dragover');
        });

        csvSection.addEventListener('dragleave', () => {
            csvSection.classList.remove('dragover');
        });

        csvSection.addEventListener('drop', (e) => {
            e.preventDefault();
            csvSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].type === 'text/csv') {
                handleFile(files[0]);
            }
        });

        csvFile.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function handleFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSV(csv);
                
                // Show file info
                document.getElementById('fileName').textContent = file.name;
                document.getElementById('rowCount').textContent = csvData.length;
                document.getElementById('columnCount').textContent = csvHeaders.length;
                fileInfo.classList.add('show');
                
                // Show column selector
                populateColumnSelect();
                columnSelector.classList.add('show');
                
                // Show preview
                showCSVPreview();
            };
            reader.readAsText(file);
        }

        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim() !== '');
            csvHeaders = lines[0].split(',').map(header => header.trim().replace(/"/g, ''));
            csvData = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim().replace(/"/g, ''));
                if (values.length === csvHeaders.length) {
                    csvData.push(values);
                }
            }
        }

        function populateColumnSelect() {
            // Populate balance column select
            balanceColumnSelect.innerHTML = '<option value="">Choose balance column...</option>';
            reasonColumnSelect.innerHTML = '<option value="">Choose reason column...</option>';
            
            csvHeaders.forEach((header, index) => {
                // Balance column options
                const balanceOption = document.createElement('option');
                balanceOption.value = index;
                balanceOption.textContent = header;
                balanceColumnSelect.appendChild(balanceOption);
                
                // Reason column options
                const reasonOption = document.createElement('option');
                reasonOption.value = index;
                reasonOption.textContent = header;
                reasonColumnSelect.appendChild(reasonOption);
            });
        }

        function showCSVPreview() {
            const thead = document.getElementById('csvTableHead');
            const tbody = document.getElementById('csvTableBody');
            
            // Clear previous content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Create header row
            const headerRow = document.createElement('tr');
            csvHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Create data rows (show first 10 rows)
            const previewData = csvData.slice(0, 10);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cell => {
                    const td = document.createElement('td');
                    td.textContent = cell;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            csvPreview.style.display = 'block';
        }

        balanceColumnSelect.addEventListener('change', checkFormValid);
        reasonColumnSelect.addEventListener('change', checkFormValid);
        
        function checkFormValid() {
            calculateButton.disabled = balanceColumnSelect.value === '' || reasonColumnSelect.value === '';
        }

        calculateButton.addEventListener('click', () => {
            const balanceColumnIndex = parseInt(balanceColumnSelect.value);
            const reasonColumnIndex = parseInt(reasonColumnSelect.value);
            
            // Group data by bad debt loss reason
            const groupedData = {};
            let totalBadDebt = 0;
            let totalAccounts = 0;
            let validAccounts = 0;
            
            csvData.forEach(row => {
                const balanceValue = row[balanceColumnIndex];
                const reasonValue = row[reasonColumnIndex];
                const numBalance = parseFloat(balanceValue);
                
                if (!isNaN(numBalance) && balanceValue.trim() !== '' && reasonValue && reasonValue.trim() !== '') {
                    const reason = reasonValue.trim();
                    
                    if (!groupedData[reason]) {
                        groupedData[reason] = {
                            totalAmount: 0,
                            accountCount: 0,
                            accounts: []
                        };
                    }
                    
                    groupedData[reason].totalAmount += numBalance;
                    groupedData[reason].accountCount += 1;
                    groupedData[reason].accounts.push({
                        balance: numBalance,
                        row: row
                    });
                    
                    totalBadDebt += numBalance;
                    validAccounts++;
                }
                totalAccounts++;
            });
            
            // Display summary results
            document.getElementById('totalBadDebt').textContent = '$' + totalBadDebt.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('totalAccounts').textContent = validAccounts + ' of ' + totalAccounts;
            document.getElementById('uniqueReasons').textContent = Object.keys(groupedData).length;
            
            // Display grouped results
            displayGroupedResults(groupedData);
            
            results.classList.add('show');
            groupedResults.style.display = 'block';
            
            // Scroll to results
            results.scrollIntoView({ behavior: 'smooth' });
        });
        
        function displayGroupedResults(groupedData) {
            const container = document.getElementById('groupedResultsContent');
            container.innerHTML = '';
            
            // Sort by total amount (descending)
            const sortedReasons = Object.keys(groupedData).sort((a, b) => 
                groupedData[b].totalAmount - groupedData[a].totalAmount
            );
            
            sortedReasons.forEach(reason => {
                const data = groupedData[reason];
                const percentage = ((data.totalAmount / document.getElementById('totalBadDebt').textContent.replace(/[$,]/g, '')) * 100).toFixed(1);
                
                const reasonDiv = document.createElement('div');
                reasonDiv.className = 'reason-group';
                
                reasonDiv.innerHTML = `
                    <div class="reason-title">
                        <span>${reason}</span>
                        <span class="reason-amount">$${data.totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                    <div class="reason-details">
                        <span>${data.accountCount} accounts</span>
                        <span>${percentage}% of total bad debt</span>
                        <span>Avg: $${(data.totalAmount / data.accountCount).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </div>
                `;
                
                container.appendChild(reasonDiv);
            });
        }

        // Store data globally for future extensions
        window.csvCalculator = {
            data: () => csvData,
            headers: () => csvHeaders,
            addComparison: function(newData, newHeaders) {
                // Future extension point for comparing multiple CSVs
                console.log('Ready for comparison feature');
            }
        };
    </script>
</body>
</html>